#!/bin/sh
echo "Running pre-commit checks..."
echo ""

# =============================================================================
# SECURITY: HOOK INTEGRITY CHECK
# =============================================================================
# Verifies critical hooks are still root-owned. Catches unlink+recreate attacks.
# This check is trustworthy: .husky/pre-commit is root-owned in a root-owned dir.
# =============================================================================

TAMPER=0
for f in pre-commit-review.js bypass-approval-hook.js block-no-verify.js \
         protected-action-gate.js protected-action-approval-hook.js \
         credential-file-guard.js secret-leak-detector.js protected-actions.json; do
  if [ -f ".claude/hooks/$f" ]; then
    uid=$(stat -f '%u' ".claude/hooks/$f" 2>/dev/null || stat -c '%u' ".claude/hooks/$f" 2>/dev/null)
    if [ "$uid" != "0" ]; then
      echo "SECURITY: .claude/hooks/$f not root-owned (uid=$uid)"
      TAMPER=1
    fi
  fi
done
if [ "$TAMPER" = "1" ]; then
  echo "COMMIT BLOCKED: Hook tampering detected. Run 'npx gentyr protect'"
  exit 1
fi
echo "Hook integrity verified"
echo ""

# =============================================================================
# LINT STAGED FILES
# =============================================================================

echo "Running lint-staged..."
npm run lint-staged
LINT_EXIT=$?
if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "Lint-staged FAILED. Fix issues before committing."
  exit 1
fi
echo "Lint-staged passed"
echo ""

# =============================================================================
# DEPUTY-CTO COMMIT REVIEW (G020)
# =============================================================================
# Spawns deputy-cto agent to review staged changes.
# Commits are blocked if:
# - There are pending CTO questions (any type, not just rejections)
# - There are untriaged agent reports
# - Deputy-CTO rejects the current changes
# =============================================================================

echo "Running deputy-cto review..."
node .claude/hooks/pre-commit-review.js
REVIEW_EXIT=$?

if [ $REVIEW_EXIT -ne 0 ]; then
  exit $REVIEW_EXIT
fi

echo ""
echo "Pre-commit checks passed"
exit 0
