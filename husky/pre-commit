#!/bin/sh
echo "Running pre-commit checks..."
echo ""

# =============================================================================
# SECURITY: HOOK INTEGRITY CHECK
# =============================================================================
# Verifies critical hooks are still root-owned. Catches unlink+recreate attacks.
# This check is trustworthy: .husky/pre-commit is root-owned in a root-owned dir.
# =============================================================================

TAMPER=0
# Prefer copy-on-protect directory (linked projects with local root-owned copies)
if [ -d ".claude/hooks-protected" ]; then
  HOOKS_CHECK_DIR=".claude/hooks-protected"
else
  HOOKS_CHECK_DIR=".claude/hooks"
fi
for f in pre-commit-review.js bypass-approval-hook.js block-no-verify.js \
         protected-action-gate.js protected-action-approval-hook.js \
         credential-file-guard.js secret-leak-detector.js protected-actions.json \
         branch-checkout-guard.js git-wrappers/git; do
  if [ -f "$HOOKS_CHECK_DIR/$f" ]; then
    uid=$(stat -f '%u' "$HOOKS_CHECK_DIR/$f" 2>/dev/null || stat -c '%u' "$HOOKS_CHECK_DIR/$f" 2>/dev/null)
    if [ "$uid" != "0" ]; then
      echo "SECURITY: $HOOKS_CHECK_DIR/$f not root-owned (uid=$uid)"
      TAMPER=1
    fi
  fi
done
if [ "$TAMPER" = "1" ]; then
  echo "COMMIT BLOCKED: Hook tampering detected. Run 'npx gentyr protect'"
  exit 1
fi
echo "Hook integrity verified"
echo ""

# =============================================================================
# SECURITY: SYMLINK TARGET VERIFICATION
# =============================================================================
# Verifies .claude/hooks points to a GENTYR framework (has version.json).
# Replaces directory root-ownership as the anti-tampering mechanism for .claude/.
# =============================================================================

if [ -L ".claude/hooks" ]; then
  HOOKS_REAL=$(cd ".claude/hooks" 2>/dev/null && pwd -P)
  FRAMEWORK_ROOT=$(dirname "$(dirname "$HOOKS_REAL")")
  if [ ! -f "$FRAMEWORK_ROOT/version.json" ]; then
    echo "COMMIT BLOCKED: .claude/hooks does not point to a GENTYR framework"
    exit 1
  fi
  echo "Symlink target verified"
elif [ -d ".claude/hooks" ]; then
  # Regular directory is only valid in the framework repo itself
  if [ ! -f "version.json" ]; then
    echo "COMMIT BLOCKED: .claude/hooks is a regular directory (expected symlink)"
    exit 1
  fi
  echo "Framework repo hooks verified"
else
  echo "COMMIT BLOCKED: .claude/hooks does not exist"
  exit 1
fi
echo ""

# =============================================================================
# SECURITY: core.hooksPath WORKTREE CHECK
# =============================================================================
# If core.hooksPath points into .claude/worktrees/, it was set by a Claude Code
# sub-agent worktree and should be reset. Auto-repairs to .husky.
# =============================================================================

HOOKS_PATH=$(git config --local --get core.hooksPath 2>/dev/null || true)
if [ -n "$HOOKS_PATH" ]; then
  case "$HOOKS_PATH" in
    */.claude/worktrees/*)
      echo "SECURITY: core.hooksPath points into a worktree: $HOOKS_PATH"
      echo "  Auto-repairing to .husky..."
      git config --local core.hooksPath .husky
      echo "  Fixed. Re-run your commit."
      exit 1
      ;;
  esac
fi
echo "core.hooksPath verified"
echo ""

# =============================================================================
# LINT STAGED FILES
# =============================================================================

echo "Running lint-staged..."
npm run lint-staged
LINT_EXIT=$?
if [ $LINT_EXIT -ne 0 ]; then
  echo ""
  echo "Lint-staged FAILED. Fix issues before committing."
  exit 1
fi
echo "Lint-staged passed"
echo ""

# =============================================================================
# DEPUTY-CTO COMMIT REVIEW (G020)
# =============================================================================
# Spawns deputy-cto agent to review staged changes.
# Commits are blocked if:
# - There are pending CTO questions (any type, not just rejections)
# - There are untriaged agent reports
# - Deputy-CTO rejects the current changes
# =============================================================================

echo "Running deputy-cto review..."
node .claude/hooks/pre-commit-review.js
REVIEW_EXIT=$?

if [ $REVIEW_EXIT -ne 0 ]; then
  exit $REVIEW_EXIT
fi

echo ""
echo "Pre-commit checks passed"
exit 0
