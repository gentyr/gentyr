<!-- GENTYR-FRAMEWORK-START -->

## GENTYR Framework

This project uses the GENTYR automation framework.

**IMPORTANT**: Do NOT manually construct setup.sh commands or grep for GENTYR scripts. Instead:
- To install, uninstall, reinstall, protect, unprotect, scaffold, or check status: call the `gentyr_setup` MCP tool (from setup-helper server). It generates the correct command with all flags and paths.
- To view or change automation frequencies/intervals/schedules: call `list_automation_config` then `set_automation_mode` MCP tools (from deputy-cto server).

### Agent Selection Guide

Choose the correct sub-agent based on what KIND of work needs to be done. Each agent has a specific domain — using the wrong agent produces worse results.

| Agent | `subagent_type` | Use when... | NEVER use for... |
|-------|-----------------|-------------|------------------|
| **INVESTIGATOR** | `investigator` | Researching a problem, understanding root cause, planning approach. Read-only — does NOT edit code. | Writing or editing any files |
| **CODE-WRITER** | `code-writer` | Writing or editing **production source code** (application logic, configs, scripts, types). | Editing test files, reviewing code |
| **TEST-WRITER** | `test-writer` | Writing, editing, or fixing **test files** (`*.test.ts`, `*.spec.ts`, `__tests__/`). Also updating tests after production code changes. | Writing production code |
| **CODE-REVIEWER** | `code-reviewer` | Reviewing all changes for quality, spec compliance, security. Commits code. | Writing production code or tests |
| **PROJECT-MANAGER** | `project-manager` | Syncing documentation (CLAUDE.md, README.md), repo cleanup, file organization. | Writing code or tests |
| **SECRET-MANAGER** | `secret-manager` | Managing secrets, API keys, env vars. Adding, rotating, syncing, or debugging credentials via GENTYR's 1Password pipeline. | Writing code, editing files |

**Critical**: Match the agent to the FILE TYPE being edited:
- Editing `src/**/*.ts` (production code) → **code-writer**
- Editing `__tests__/**/*.test.ts` or `*.spec.ts` (test files) → **test-writer**
- Editing `*.md`, `README.md`, `CLAUDE.md` (docs) → **project-manager**
- Need to understand a problem first → **investigator**
- Reviewing/committing completed work → **code-reviewer**

### Standard Development Workflow

For **new features or significant changes**, follow this full sequence:

1. **INVESTIGATOR** `Task(subagent_type='investigator')` - Research the task, understand codebase context, plan approach
2. **CODE-WRITER** `Task(subagent_type='code-writer')` - Implement production code changes
3. **TEST-WRITER** `Task(subagent_type='test-writer')` - Add/update tests for the changes
4. **CODE-REVIEWER** `Task(subagent_type='code-reviewer')` - Review all changes, validate spec compliance, commit
5. **PROJECT-MANAGER** `Task(subagent_type='project-manager')` - Sync documentation, repo cleanup (ALWAYS LAST)
6. **SUMMARY** - Report findings to deputy-cto via `mcp__agent-reports__report_to_deputy_cto`

For **scoped work** (e.g., only tests need fixing, only docs need updating), you may start at the appropriate agent and continue the sequence from there. Examples:
- Test files broken after a schema change → start at **test-writer**, then code-reviewer, project-manager
- Only documentation is outdated → start at **project-manager**
- Bug investigation needed → start at **investigator**, then follow full sequence

If a later agent discovers work that belongs to an earlier agent (e.g., test-writer finds a production bug), stop and spawn the correct agent for that work before continuing.

### Golden Rules

- **Match agent to work type** - The test-writer writes tests. The code-writer writes production code. Never cross these boundaries.
- **Follow order for the agents you use** - INVESTIGATOR → CODE-WRITER → TEST-WRITER → CODE-REVIEWER → PROJECT-MANAGER. You can skip earlier agents if their work isn't needed, but never reorder.
- **One agent per role** - Do not combine roles. The code-writer does NOT review. The code-reviewer does NOT write production code. The code-writer does NOT edit test files.
- **Use sub-agents via Task tool** - Each `Task(subagent_type='...')` loads the agent's specialized config from `.claude/agents/`. Never skip this by doing the work directly.
- **Use MCP tools** - Coordinate via `mcp__todo-db__*` for task tracking, `mcp__agent-reports__*` for CTO reporting.

### File Protection Error Handling

GENTYR protects critical files with root ownership. If ANY operation fails with `Permission denied` or `EACCES` on a GENTYR-managed file (`.claude/`, `.husky/`, `.mcp.json`, `eslint.config.js`, `package.json`):

1. Call `mcp__setup-helper__gentyr_setup({ action: "unprotect" })` to get the exact unprotect command
2. Present the command to the user (requires `sudo` in their terminal)
3. Wait for user to run it, then retry the failed operation
4. After changes are done, remind user to re-protect: `mcp__setup-helper__gentyr_setup({ action: "protect" })`

Do NOT attempt `chmod`/`chown` directly. Always use the `gentyr_setup` MCP tool.

### Secrets Management

Secrets flow through GENTYR's 1Password-based pipeline. **Values never pass through agent context.**

| Operation | How |
|-----------|-----|
| **List current mappings** | `mcp__secret-sync__secret_list_mappings` |
| **Sync to services** | `mcp__secret-sync__secret_sync_secrets({ target: "render-production" })` |
| **Verify secrets exist** | `mcp__secret-sync__secret_verify_secrets({ target: "all" })` |
| **List 1Password items** | `mcp__onepassword__list_items({ vault: "Production" })` |
| **Push all secrets** | Use `/push-secrets` slash command |

**Configuration:** `.claude/config/services.json` maps env var names to `op://` references per target (Render Production, Render Staging, Vercel).

**Local dev:** Use `op run --env-file=.env.local.template -- pnpm dev` to inject secrets at runtime without writing to disk.

**Adding new secrets:** Spawn `secret-manager` agent — `Task(subagent_type='secret-manager')`. It guides the full lifecycle: 1Password item creation, services.json mapping, sync, and verification.

**NEVER** create `.env` files with real values, hardcode credentials (G004), or expose secrets in logs/output.

### CTO Reporting

After completing work, report significant findings to the deputy-CTO:
- Use `mcp__agent-reports__report_to_deputy_cto` for issues, discoveries, or status updates
- Critical/security issues are auto-escalated to CTO
- The deputy-cto triages reports hourly

### CTO-Protected Actions

Some actions require CTO approval via the deputy-cto pipeline:
- Architectural changes affecting module boundaries
- Security-sensitive modifications
- Breaking changes to APIs or contracts
- Changes below the `<!-- CTO-PROTECTED -->` divider in CLAUDE.md

For full details on GENTYR's 7-layer protection architecture (root ownership, MCP gating, bash blocking, commit review, secret isolation, credential guards, agent restrictions), see `.claude/docs/PROTECTION-SYSTEM.md`.

### Deployment Flow

`feature branch` → `preview` → `staging` → `production`

Each stage has automated validation. Feedback agents test staging changes automatically.

<!-- GENTYR-FRAMEWORK-END -->
